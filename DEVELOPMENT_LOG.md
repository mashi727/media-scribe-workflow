# Development Log

開発ログ（2025-12-29〜）

過去のログは `DEVELOPMENT_LOG_as_of_2025-12-29.md` を参照。

---

## 2025-12-29: UI大改造計画

### 背景・課題

現状のワークフローでMP3からMP4を生成する際、2回のエンコードが発生：

```
現状（2回エンコード）:
  MP3 → [enc] → 中間MP4 → [enc] → 最終MP4
              ↑ここで劣化    ↑さらに劣化
```

### 設計目標

- エンコード1回のみで劣化最小化
- 処理オーバーヘッドの最小化
- タイトル焼込は必須要件として維持

### 検討過程

#### 1. 一筆書き問題の認識（グラフ理論的アプローチ）

ワークフロー設計を**グラフ理論**の観点から分析。

**問題の本質**: 入力パターン（起点）が3つ以上存在する場合、機能重複が発生しやすい。
これは**オイラー路（一筆書き）問題**に類似：奇数次数の頂点が2つより多いと一筆書き不可能。

**起点（入力パターン）:**
1. 複数のカット済みMP3
2. 単一の長尺未編集MP3
3. 既存のMP4

**終点:**
- チャプター付きMP4

**処理ノード:**

| ノード | 必要な起点 |
|--------|-----------|
| 結合 | 起点1のみ |
| カバー画像 | MP3入力時のみ |
| チャプター編集 | 全起点 |
| 書出 | 全起点 |

**一筆書きできない構造（初期設計）:**

```mermaid
graph LR
    A1[起点1: 複数MP3] --> B[結合]
    B --> C[カバー画像]
    A2[起点2: 単体MP3] --> C
    C --> D[チャプター編集]
    A3[起点3: MP4] --> D
    D --> E[書出]
    E --> F[最終MP4]

    style A1 fill:#e1f5fe
    style A2 fill:#e1f5fe
    style A3 fill:#e1f5fe
    style F fill:#c8e6c9
```

問題: 起点2→カバー画像、起点3→チャプター編集と、経路が分散している。

**解決策: 共通パスを1つにし、入口を分岐**

```mermaid
graph LR
    subgraph 入口分岐
        A1[起点1: 複数MP3] --> B[結合]
        A2[起点2: 単体MP3]
        A3[起点3: MP4]
    end

    subgraph 共通パス
        B --> C{MP3?}
        A2 --> C
        A3 --> D[チャプター編集]
        C -->|Yes| CV[カバー画像]
        C -->|No| D
        CV --> D
        D --> E[書出]
    end

    E --> F[最終MP4]

    style A1 fill:#e1f5fe
    style A2 fill:#e1f5fe
    style A3 fill:#e1f5fe
    style F fill:#c8e6c9
    style D fill:#fff9c4
    style E fill:#fff9c4
```

**洞察**: 機能重複は「起点が3つ以上ある」ことに起因。共通パスを明確にし、
入口のみを分岐させることで重複を排除できる。

#### 2. 制約条件による設計空間の縮小

制約を追加することで設計が明確化される逆説的な効果を確認。

**制約なし（最初の状態）:**

```mermaid
graph TD
    subgraph "設計空間: 8パターン"
        R[ルート] --> T{焼込?}
        T -->|あり| T1[焼込あり]
        T -->|なし| T2[焼込なし]
        T1 --> C{カット?}
        T2 --> C
        C -->|あり| C1[カットあり]
        C -->|なし| C2[カットなし]
        C1 --> I{入力?}
        C2 --> I
        I -->|MP3| I1[MP3]
        I -->|MP4| I2[MP4]
    end

    style R fill:#ffcdd2
```

**制約追加後（タイトル焼込必須）:**

```mermaid
graph TD
    subgraph "設計空間: 2パターンに縮小"
        R[ルート] --> T[焼込あり固定]
        T --> V[映像: 1回enc必須]
        V --> I{入力?}
        I -->|MP3| I1[MP3: 静止画+焼込]
        I -->|MP4| I2[MP4: 焼込のみ]
    end

    style R fill:#c8e6c9
    style T fill:#c8e6c9
```

**最適化されたエンコード戦略:**

| 入力 | 映像処理 | 音声処理 |
|------|----------|----------|
| MP3 | enc(静止画+焼込) 1回 | enc 1回 |
| MP4 | enc(焼込) 1回 | **copy（無劣化）** |

**洞察**: 制約は自由度を狭めるが、設計空間を明確にし、最適解を見つけやすくする。

#### 3. Tab構成の検討

**初期案**: 2タブ構成（入力準備 + 編集・書出）

**問題点**: Tab 1のMP3結合は無劣化（-c copy）で可能。中間ファイルが不要ならタブを分ける意味が薄い。

**議論の流れ:**
1. 「タブ1とタブ2を分けなくても良いのでは？」→ 陶器（UI）が巨大化する懸念
2. 「入力ソースも別画面では？」→ ダイアログパターンの発見
3. 「チャプター自動挿入、カバー画像も自動適用」→ 統一的なUXパターン

#### 4. 最終決定: 単一画面 + ダイアログ（モーダル分離パターン）

**アーキテクチャ:**

```mermaid
graph TB
    subgraph メイン画面
        M[MainWorkspace]
        M --> W[波形表示]
        M --> CT[チャプターテーブル]
        M --> EX[書出設定・実行]
    end

    subgraph ダイアログ
        SD[SourceSelectionDialog]
        CD[CoverImageDialog]
    end

    M -.->|ボタン| SD
    M -.->|ボタン| CD
    SD -->|自動反映| M
    CD -->|自動反映| M

    style M fill:#e3f2fd
    style SD fill:#fff3e0
    style CD fill:#fff3e0
```

**UI構成:**

```
┌─────────────────────────────────────────────┐
│ [ソース選択] [カバー画像]  ← ボタンで別画面 │
│                                             │
│ ソース: audio.mp3 (14:20)                   │
│ カバー: cover.jpg (1920x1080)               │
│                                             │
│ [波形表示]                                  │
│ ════════════════════════════════════════    │
│                                             │
│ [チャプターテーブル]                        │
│ │ 00:00 | 第1曲 ホルスト 木星              │
│ │ 05:23 | 第2曲 エルガー 威風堂々          │
│                                             │
│ [書出設定] [書出]                           │
└─────────────────────────────────────────────┘
```

### 決定事項

1. **単一画面構成**: タブを廃止、メイン画面1つに統合
2. **ダイアログパターン**:
   - ソース選択ダイアログ: MP3/MP4追加・並替 → 自動でチャプター挿入
   - カバー画像ダイアログ: 選択・クロップ → 自動適用
3. **エンコード最適化**:
   - MP3結合は無劣化（-c copy）
   - 最終書出で1回のみエンコード
   - MP4入力時の音声は無劣化copy

### 各ケースのフロー

```mermaid
flowchart LR
    subgraph "ケースA: 複数MP3"
        A1[ソース選択] --> A2[自動結合]
        A2 --> A3[カバー設定]
        A3 --> A4[チャプター編集]
        A4 --> A5[書出]
    end
```

```mermaid
flowchart LR
    subgraph "ケースB: 単体MP3"
        B1[ソース選択] --> B2[カバー設定]
        B2 --> B3[チャプター編集]
        B3 --> B4[書出]
    end
```

```mermaid
flowchart LR
    subgraph "ケースC: MP4"
        C1[ソース選択] --> C2[チャプター編集]
        C2 --> C3[書出]
    end

    style C1 fill:#e8f5e9
    style C2 fill:#e8f5e9
    style C3 fill:#e8f5e9
```

| ケース | カバー画像 | 結合 | エンコード |
|--------|-----------|------|-----------|
| A. 複数MP3 | 必要 | 必要 | 映像1回 + 音声1回 |
| B. 単体MP3 | 必要 | 不要 | 映像1回 + 音声1回 |
| C. MP4 | 不要 | 不要 | 映像1回 + 音声copy |

### メリット

- メイン画面はシンプル（表示と編集に集中）
- 各ダイアログは単一責務
- 明示的な「保存」「適用」ボタン不要
- タブ切替なし、迷わない
- エンコード1回のみ、劣化最小

### 設計原則（本議論から得られた知見）

1. **グラフ構造での問題分析**: ワークフローを有向グラフとして捉え、起点・終点・ノードを明確化
2. **共通パスの抽出**: 複数の起点が合流する「共通パス」を見つけ、そこを中心に設計
3. **制約による単純化**: 制約は選択肢を狭めるが、設計を明確にする効果がある
4. **モーダル分離パターン**: 複雑な入力はダイアログに分離し、メイン画面をシンプルに保つ
5. **自動適用の原則**: ダイアログを閉じると自動で反映、明示的な「保存」ボタン不要

### 次のステップ

- [ ] 現在の2タブ構成を単一画面に統合
- [ ] SourceSelectionDialog の実装
- [ ] CoverImageDialog の実装
- [ ] MainWorkspace の実装
- [ ] ffmpegコマンドの最適化（1パス処理）

### 関連ファイル

- `docs/dev-log-ui-redesign-2025-12-29.md` - 詳細な議論ログ

---

## 今後の予定

### video-chapter-editor

- UI大改造（上記）
- 単一エンコードパス実装

### report-workflow

- 配管のプロトタイプは完了
- 陶器（GUI）の設計は video-chapter-editor 完成後

---

**更新**: 2025-12-29
