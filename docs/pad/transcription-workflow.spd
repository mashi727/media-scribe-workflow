# transcription-workflow.spd
# 文字起こしワークフロー 処理フロー

:terminal 開始

:comment ============================================
:comment Phase 1: 初期化
:comment ============================================

:switch 起動方法
:case 設定ファイル指定
	:call 設定ファイル読み込み
		YAML パース
		バリデーション
:case 新規作成
	:call プロファイル選択UI
		プロファイル一覧表示
		ユーザー選択
	:call 設定ファイル生成
		field_schema からフォーム生成
		デフォルト値設定

:comment ============================================
:comment Phase 2: プロファイル解決
:comment ============================================

:call プロファイル読み込み
	:switch 検索順序
	:case 作業ディレクトリ内
		./profiles/{name}.yaml
	:case ユーザー設定
		~/.config/rehearsal-workflow/profiles/{name}.yaml
	:case ビルトイン
		パッケージ内蔵

:call リソース読み込み
	base_template 読み込み
	macros 読み込み
	prompt_template 読み込み
	glossary 読み込み（存在時）

:comment ============================================
:comment Phase 3: 入力状態判定
:comment ============================================

:call 入力状態判定
	:switch 判定結果
	:case S1: YouTube URL のみ
		source.state.video = "url_only"
		source.state.youtube_srt = "missing"
	:case S2: ローカル動画のみ
		source.state.video = "ready"
		source.state.youtube_srt = "not_applicable"
		source.state.whisper_srt = "missing"
	:case S3: 動画 + YT字幕あり
		source.state.video = "ready"
		source.state.youtube_srt = "exists"
	:case S4: 動画 + Whisper字幕あり
		source.state.video = "ready"
		source.state.whisper_srt = "exists"
	:case S5: 動画 + 両方あり
		source.state.youtube_srt = "exists"
		source.state.whisper_srt = "exists"
	:case S6: 動画 + 手動SRTあり
		source.state.manual_srt = "exists"
	:case S7: YouTube DL済み 字幕なし
		source.state.video = "ready"
		source.state.youtube_srt = "missing"

:comment ============================================
:comment Phase 4: ソース処理（状態に応じた処理）
:comment ============================================

:switch source.state.video
:case url_only
	:call YouTube動画+字幕取得
		ytdl 実行（動画+字幕同時）
		動画保存
		SRT 保存
		source.state 更新
:case ready
	動画ファイル確認済み

:comment ============================================
:comment Phase 5: 文字起こし（SRT取得）
:comment ============================================

:switch transcription.method
:case auto
	:call 自動判定
		:if source.state.*_srt いずれか exists
			method = "skip"
		:else
			auto_priority に従い決定
:case youtube
	:if source.state.youtube_srt = "missing"
		:call yt-srt 実行
			YouTube字幕取得
			SRT 保存
:case whisper
	:if source.state.whisper_srt = "missing"
		:call Whisper文字起こし
			whisper-remote 実行
			SRT 生成
:case manual
	:if source.state.manual_srt = "missing"
		ユーザーにSRTファイル指定を要求
:case skip
	既存SRTを使用（処理なし）

:if 複数SRTあり
	:call SRT統合
		タイムスタンプ照合
		相補的マージ

:comment ============================================
:comment Phase 6: プロンプト生成
:comment ============================================

:call テンプレート変数展開
	:loop field_schema
		{{label}} → プロファイル定義
		{{value}} → 設定ファイル値

:call 参加者情報展開
	:switch participants.type
	:case hierarchical
		講師/生徒 構造展開
	:case flat
		参加者リスト展開

:call 字幕データ埋め込み
	{{transcript}} → SRT内容
	{{youtube_srt}} → YouTube字幕
	{{whisper_srt}} → Whisper字幕

:call プロンプト出力
	prompt_for_ai.md 生成
	クリップボードコピー（オプション）

:comment ============================================
:comment Phase 7: AI処理（外部）
:comment ============================================

:comment ユーザーがWeb AIまたはCLIで実行
Claude / ChatGPT / ローカルLLM

:comment ============================================
:comment Phase 8: 出力生成
:comment ============================================

:switch output.format
:case markdown
	Markdown 出力
:case latex
	:call LaTeX生成
		base_template 適用
		macros 展開
		コンテンツ埋め込み
	:call コンパイル
		luatex-pdf 実行
		PDF 生成
:case docx
	:call Word生成
		pandoc 変換

:if output.additional_files
	:loop 追加出力
		:switch type
		:case chapters
			チャプターファイル生成

:call 状態保存
	status.phase = "done"
	status.artifacts 更新
	updated_at 記録

:terminal 終了
