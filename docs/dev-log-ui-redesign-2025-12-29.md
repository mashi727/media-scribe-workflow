# UI大改造 開発ログ

**日付**: 2025-12-29
**対象**: video-chapter-editor

## 背景

### 問題点
現状のワークフローでは、MP3からMP4を生成する際に2回エンコードが発生する：

```
現状（2回エンコード）:
  MP3 → [enc] → 中間MP4 → [enc] → 最終MP4
              ↑ここで劣化    ↑さらに劣化
```

### 設計目標
- 劣化を最小化（エンコード1回のみ）
- 処理オーバーヘッドを最小化
- タイトル焼込は必須要件として維持

## 議論の経緯

### 1. 一筆書き問題の認識

入力パターン（起点）が3つ存在：
1. 複数のカット済みMP3
2. 単一の長尺未編集MP3
3. 既存のMP4

これらを機能重複なく処理するには、共通パスの設計が重要。

### 2. 制約条件の整理

**タイトル焼込必須の影響：**

| 要素 | 処理内容 | 再エンコード必要？ |
|------|----------|------------------|
| カバー画像 | 静止画→映像化 | 生成必要（MP3のみ） |
| タイトル焼込 | フレームに文字描画 | **必要** |
| チャプターメタデータ | コンテナに埋込 | 不要 |
| カット編集 | 区間削除 | キーフレーム境界なら不要 |

焼込必須により、映像は必ず1回エンコードが必要。この制約により設計空間が狭まり、方針が明確になった。

### 3. 最適化されたエンコード戦略

**焼込必須時の最小エンコード構成：**

```
MP3入力:
  映像: 静止画+焼込 → 1回enc
  音声: MP3→AAC 1回enc

MP4入力:
  映像: 焼込のため → 1回re-enc（避けられない）
  音声: -c:a copy（劣化ゼロ）
```

### 4. Tab構成の検討

**初期案：2タブ構成**
- Tab 1: 入力準備（結合 or 選択）
- Tab 2: 編集・書出（共通パス）

**問題点**
- Tab 1のMP3結合は無劣化（-c copy）で可能
- 中間ファイルが不要なら、タブを分ける意味が薄い

### 5. 最終設計：単一画面 + ダイアログ

**統一アーキテクチャ：**

```
メイン画面（ワークスペース）
┌─────────────────────────────────────────────┐
│ [ソース選択] [カバー画像]  ← ボタンで別画面 │
│                                             │
│ ソース: audio.mp3 (14:20)                   │
│ カバー: cover.jpg (1920x1080)               │
│                                             │
│ [波形表示]                                  │
│ ════════════════════════════════════════    │
│                                             │
│ [チャプターテーブル]                        │
│ │ 00:00 | 第1曲 ホルスト 木星              │
│ │ 05:23 | 第2曲 エルガー 威風堂々          │
│ │ 09:45 | 第3曲 スーザ 星条旗よ永遠なれ    │
│                                             │
│ [書出設定] [書出]                           │
└─────────────────────────────────────────────┘
```

**ダイアログのパターン：**

| ダイアログ | 操作 | 閉じると |
|-----------|------|---------|
| ソース選択 | MP3/MP4追加・並替 | → 自動で波形更新 + チャプター挿入 |
| カバー画像 | 選択・クロップ | → 自動でカバー設定 |

## 決定事項

1. **単一画面構成**：タブを廃止し、メイン画面1つに統合
2. **ダイアログパターン**：ソース選択・カバー画像は別画面（ダイアログ）
3. **自動挿入**：
   - 複数MP3結合時 → チャプター自動生成
   - カバー画像設定時 → 明示的な保存不要、自動適用
4. **エンコード最適化**：
   - MP3結合は無劣化（-c copy）
   - 最終書出で1回のみエンコード
   - MP4入力時の音声は無劣化copy

## 各ケースのフロー

| ケース | フロー |
|--------|--------|
| A. 複数MP3 | ソース選択ダイアログ → カバー設定 → チャプター編集 → 書出 |
| B. 単体MP3 | ソース選択ダイアログ → カバー設定 → チャプター編集 → 書出 |
| C. MP4 | ソース選択ダイアログ → チャプター編集 → 書出（カバー不要） |

## メリット

- メイン画面はシンプル（表示と編集に集中）
- 各ダイアログは単一責務
- 明示的な「保存」「適用」ボタン不要
- タブ切替なし、迷わない
- エンコード1回のみ、劣化最小

## 次のステップ

1. 現在のコードをコミット（UIモダン化の変更）
2. 新設計に基づくリファクタリング開始
   - MergeTab → SourceSelectionDialog
   - EditTab → MainWorkspace
   - カバー画像機能 → CoverImageDialog
