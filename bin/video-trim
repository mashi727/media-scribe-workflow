#!/usr/bin/env zsh
# ==============================================================================
# video-trim - 動画の不要部分を削除
# ==============================================================================
#
# 概要:
#   動画ファイルの開始・終了時刻を指定して不要部分をカットする。
#   休憩時間、準備、片付けなどの削除に使用。
#   「Gitの陶器と配管」思想に基づくシンプルな配管ツール。
#
# 使用方法:
#   video-trim <input_video> [OPTIONS]
#
# 引数:
#   input_video  - 入力動画ファイル（必須）
#
# オプション:
#   -s, --start TIME   - 開始時刻（HH:MM:SS または秒数）
#   -e, --end TIME     - 終了時刻（HH:MM:SS または秒数）
#   -d, --duration SEC - 開始から指定秒数
#   -o, --output FILE  - 出力ファイル名（デフォルト: <input>_trimmed.mp4）
#   -c, --copy         - 再エンコードなし（高速だがキーフレーム単位）
#   -h, --help         - ヘルプを表示
#
# 出力:
#   トリミングされた動画ファイル
#
# 依存:
#   - ffmpeg: 動画処理ツール
#
# 作成日: 2025-12-24
# バージョン: 1.0.0
# ==============================================================================

# ------------------------------------------------------------------------------
# ヘルプ表示
# ------------------------------------------------------------------------------
show_help() {
    cat << 'EOF'
Usage: video-trim <input_video> [OPTIONS]

動画の不要部分を削除します。

Options:
  -s, --start TIME    開始時刻（HH:MM:SS or 秒数）
  -e, --end TIME      終了時刻（HH:MM:SS or 秒数）
  -d, --duration SEC  開始から指定秒数
  -o, --output FILE   出力ファイル名
  -c, --copy          再エンコードなし（高速）
  -h, --help          このヘルプを表示

Examples:
  # 開始から1時間のみ抽出
  video-trim input.mp4 -s 0 -d 3600

  # 10分から30分まで抽出
  video-trim input.mp4 -s 00:10:00 -e 00:30:00

  # 最初の5分をカット（5分以降を抽出）
  video-trim input.mp4 -s 00:05:00

  # 高速モード（再エンコードなし）
  video-trim input.mp4 -s 00:05:00 -e 01:00:00 -c
EOF
}

# ------------------------------------------------------------------------------
# 色付きログ出力
# ------------------------------------------------------------------------------
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

log_info() { echo "${GREEN}[INFO]${NC} $1" }
log_warn() { echo "${YELLOW}[WARN]${NC} $1" }
log_error() { echo "${RED}[ERROR]${NC} $1" >&2 }
log_step() { echo "${CYAN}[STEP]${NC} $1" }

# ------------------------------------------------------------------------------
# 引数解析
# ------------------------------------------------------------------------------
local input_file=""
local start_time=""
local end_time=""
local duration=""
local output_file=""
local copy_mode=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            return 0
            ;;
        -s|--start)
            start_time="$2"
            shift 2
            ;;
        -e|--end)
            end_time="$2"
            shift 2
            ;;
        -d|--duration)
            duration="$2"
            shift 2
            ;;
        -o|--output)
            output_file="$2"
            shift 2
            ;;
        -c|--copy)
            copy_mode=true
            shift
            ;;
        -*)
            log_error "Unknown option: $1"
            show_help
            return 1
            ;;
        *)
            if [[ -z "$input_file" ]]; then
                input_file="$1"
            fi
            shift
            ;;
    esac
done

# ------------------------------------------------------------------------------
# 検証
# ------------------------------------------------------------------------------
if [[ -z "$input_file" ]]; then
    log_error "Input file is required"
    show_help
    return 1
fi

if [[ ! -f "$input_file" ]]; then
    log_error "Input file not found: $input_file"
    return 1
fi

# ffmpegの存在確認
if ! command -v ffmpeg &>/dev/null; then
    log_error "ffmpeg is not installed"
    echo "Install with: brew install ffmpeg" >&2
    return 1
fi

# 少なくとも1つの時間指定が必要
if [[ -z "$start_time" && -z "$end_time" && -z "$duration" ]]; then
    log_error "At least one of -s, -e, or -d is required"
    show_help
    return 1
fi

# duration と end は同時に使用不可
if [[ -n "$duration" && -n "$end_time" ]]; then
    log_error "Cannot use both -d (duration) and -e (end) options"
    return 1
fi

# ------------------------------------------------------------------------------
# 出力ファイル名の決定
# ------------------------------------------------------------------------------
if [[ -z "$output_file" ]]; then
    local basename="${input_file:r}"
    local ext="${input_file:e}"
    output_file="${basename}_trimmed.${ext:-mp4}"
fi

# ------------------------------------------------------------------------------
# ffmpegオプションの構築
# ------------------------------------------------------------------------------
local ffmpeg_opts=(-hide_banner -loglevel warning -stats)

# 開始時刻
if [[ -n "$start_time" ]]; then
    ffmpeg_opts+=(-ss "$start_time")
fi

# 入力ファイル
ffmpeg_opts+=(-i "$input_file")

# 終了時刻または長さ
if [[ -n "$end_time" ]]; then
    ffmpeg_opts+=(-to "$end_time")
elif [[ -n "$duration" ]]; then
    ffmpeg_opts+=(-t "$duration")
fi

# エンコード設定
if [[ "$copy_mode" == true ]]; then
    log_info "Using copy mode (no re-encode)"
    ffmpeg_opts+=(-c copy)
else
    log_info "Re-encoding for precise cuts"
    ffmpeg_opts+=(-c:v libx264 -preset fast -crf 23 -c:a aac -b:a 128k)
fi

# 上書き確認
ffmpeg_opts+=(-y)

# 出力ファイル
ffmpeg_opts+=("$output_file")

# ------------------------------------------------------------------------------
# トリミング実行
# ------------------------------------------------------------------------------
log_step "Trimming video..."
log_info "Input:  ${input_file}"
log_info "Output: ${output_file}"

if [[ -n "$start_time" ]]; then
    log_info "Start:  ${start_time}"
fi
if [[ -n "$end_time" ]]; then
    log_info "End:    ${end_time}"
fi
if [[ -n "$duration" ]]; then
    log_info "Duration: ${duration}s"
fi

echo ""

if ! ffmpeg "${ffmpeg_opts[@]}"; then
    log_error "Trimming failed"
    return 1
fi

echo ""

# ------------------------------------------------------------------------------
# 結果表示
# ------------------------------------------------------------------------------
if [[ -f "$output_file" ]]; then
    local input_size=$(du -h "$input_file" | cut -f1)
    local output_size=$(du -h "$output_file" | cut -f1)

    log_info "Trimming complete!"
    log_info "  Input:  ${input_file} (${input_size})"
    log_info "  Output: ${output_file} (${output_size})"
else
    log_error "Output file was not created"
    return 1
fi

# ==============================================================================
# 使用例:
#   video-trim rehearsal.mp4 -s 00:05:00 -e 02:30:00
#   video-trim rehearsal.mp4 -s 300 -d 7200 -o trimmed.mp4
#   video-trim rehearsal.mp4 -s 00:10:00 -c
# ==============================================================================
