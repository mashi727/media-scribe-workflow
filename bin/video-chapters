#!/usr/bin/env zsh
# ==============================================================================
# video-chapters - チャプター付き動画の結合・作成
# ==============================================================================
#
# 概要:
#   複数の動画を結合し、チャプター情報を埋め込んだ単一のMP4ファイルを作成する。
#   または既存の動画にチャプターメタデータを追加する。
#   「Gitの陶器と配管」思想に基づくシンプルな配管ツール。
#
# 使用方法:
#   video-chapters <command> [OPTIONS]
#
# コマンド:
#   concat   - 複数動画を結合（チャプター自動生成）
#   embed    - 既存動画にチャプターを埋め込み
#   extract  - 動画からチャプター情報を抽出
#
# 依存:
#   - ffmpeg: 動画処理ツール
#
# 作成日: 2025-12-24
# バージョン: 1.0.0
# ==============================================================================

# ------------------------------------------------------------------------------
# ヘルプ表示
# ------------------------------------------------------------------------------
show_help() {
    cat << 'EOF'
Usage: video-chapters <command> [OPTIONS]

チャプター付き動画の結合・作成

Commands:
  concat   複数動画を結合（チャプター自動生成）
  embed    既存動画にチャプターを埋め込み
  extract  動画からチャプター情報を抽出

Examples:
  # 複数動画を結合
  video-chapters concat -o output.mp4 video1.mp4 video2.mp4 video3.mp4

  # チャプターファイルで埋め込み
  video-chapters embed -i input.mp4 -c chapters.txt -o output.mp4

  # チャプター情報を抽出
  video-chapters extract -i input.mp4

Run 'video-chapters <command> --help' for more details.
EOF
}

show_concat_help() {
    cat << 'EOF'
Usage: video-chapters concat [OPTIONS] <video1> <video2> ...

複数の動画ファイルを結合し、各動画をチャプターとして設定します。

Options:
  -o, --output FILE   出力ファイル名（必須）
  -n, --names FILE    チャプター名リスト（1行1名、省略時はファイル名）
  -h, --help          このヘルプを表示

Chapter Name File Format (optional):
  第1楽章
  第2楽章
  第3楽章

Examples:
  video-chapters concat -o combined.mp4 mov1.mp4 mov2.mp4 mov3.mp4
  video-chapters concat -o combined.mp4 -n chapters.txt *.mp4
EOF
}

show_embed_help() {
    cat << 'EOF'
Usage: video-chapters embed [OPTIONS]

既存の動画にチャプター情報を埋め込みます。

Options:
  -i, --input FILE    入力動画ファイル（必須）
  -c, --chapters FILE チャプターファイル（必須）
  -o, --output FILE   出力ファイル名（デフォルト: <input>_chapters.mp4）
  -h, --help          このヘルプを表示

Chapter File Format:
  00:00:00 オープニング
  00:05:30 第1楽章
  00:15:45 第2楽章

Examples:
  video-chapters embed -i video.mp4 -c chapters.txt -o output.mp4
EOF
}

show_extract_help() {
    cat << 'EOF'
Usage: video-chapters extract [OPTIONS]

動画ファイルからチャプター情報を抽出します。

Options:
  -i, --input FILE   入力動画ファイル（必須）
  -o, --output FILE  出力ファイル（省略時は標準出力）
  -h, --help         このヘルプを表示

Examples:
  video-chapters extract -i video.mp4
  video-chapters extract -i video.mp4 -o chapters.txt
EOF
}

# ------------------------------------------------------------------------------
# 色付きログ出力
# ------------------------------------------------------------------------------
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

log_info() { echo "${GREEN}[INFO]${NC} $1" }
log_warn() { echo "${YELLOW}[WARN]${NC} $1" }
log_error() { echo "${RED}[ERROR]${NC} $1" >&2 }
log_step() { echo "${CYAN}[STEP]${NC} $1" }

# ------------------------------------------------------------------------------
# ffmpegの存在確認
# ------------------------------------------------------------------------------
check_ffmpeg() {
    if ! command -v ffmpeg &>/dev/null; then
        log_error "ffmpeg is not installed"
        echo "Install with: brew install ffmpeg" >&2
        return 1
    fi
    if ! command -v ffprobe &>/dev/null; then
        log_error "ffprobe is not installed"
        return 1
    fi
}

# ------------------------------------------------------------------------------
# 時間を秒に変換
# ------------------------------------------------------------------------------
time_to_seconds() {
    local time="$1"
    if [[ "$time" =~ ^([0-9]+):([0-9]{2}):([0-9]{2})(\.([0-9]+))?$ ]]; then
        local h="${match[1]}"
        local m="${match[2]}"
        local s="${match[3]}"
        local ms="${match[5]:-0}"
        echo "$(( h * 3600 + m * 60 + s )).${ms}"
    elif [[ "$time" =~ ^([0-9]+):([0-9]{2})(\.([0-9]+))?$ ]]; then
        local m="${match[1]}"
        local s="${match[2]}"
        local ms="${match[4]:-0}"
        echo "$(( m * 60 + s )).${ms}"
    else
        echo "$time"
    fi
}

# ------------------------------------------------------------------------------
# 動画の長さを取得（秒）
# ------------------------------------------------------------------------------
get_duration() {
    ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$1" 2>/dev/null
}

# ------------------------------------------------------------------------------
# concat コマンド
# ------------------------------------------------------------------------------
cmd_concat() {
    local output_file=""
    local names_file=""
    local video_files=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help) show_concat_help; return 0 ;;
            -o|--output) output_file="$2"; shift 2 ;;
            -n|--names) names_file="$2"; shift 2 ;;
            -*) log_error "Unknown option: $1"; return 1 ;;
            *) video_files+=("$1"); shift ;;
        esac
    done

    if [[ -z "$output_file" ]]; then
        log_error "Output file (-o) is required"
        return 1
    fi

    if [[ ${#video_files[@]} -lt 2 ]]; then
        log_error "At least 2 video files are required"
        return 1
    fi

    # 入力ファイルの確認
    for f in "${video_files[@]}"; do
        if [[ ! -f "$f" ]]; then
            log_error "File not found: $f"
            return 1
        fi
    done

    log_step "Concatenating ${#video_files[@]} videos..."

    # 一時ファイルリスト作成
    local concat_list=$(mktemp)
    local metadata_file=$(mktemp)
    local current_time=0

    # ffmpegメタデータヘッダー
    echo ";FFMETADATA1" > "$metadata_file"

    local chapter_names=()
    if [[ -n "$names_file" && -f "$names_file" ]]; then
        while IFS= read -r line; do
            chapter_names+=("$line")
        done < "$names_file"
    fi

    local i=0
    for f in "${video_files[@]}"; do
        echo "file '$(realpath "$f")'" >> "$concat_list"

        # チャプター名
        local chapter_name
        if [[ $i -lt ${#chapter_names[@]} ]]; then
            chapter_name="${chapter_names[$i]}"
        else
            chapter_name="${f:t:r}"
        fi

        # 動画の長さを取得
        local duration=$(get_duration "$f")
        local start_ms=$(printf "%.0f" $(echo "$current_time * 1000" | bc))
        local end_ms=$(printf "%.0f" $(echo "($current_time + $duration) * 1000" | bc))

        # チャプターエントリ追加
        cat >> "$metadata_file" << EOF

[CHAPTER]
TIMEBASE=1/1000
START=${start_ms}
END=${end_ms}
title=${chapter_name}
EOF

        current_time=$(echo "$current_time + $duration" | bc)
        ((i++))
        log_info "  $f -> $chapter_name"
    done

    log_step "Merging videos with chapters..."

    # 結合実行
    if ! ffmpeg -hide_banner -loglevel warning -stats \
        -f concat -safe 0 -i "$concat_list" \
        -i "$metadata_file" -map_metadata 1 \
        -c copy -y "$output_file"; then
        log_error "Concatenation failed"
        rm -f "$concat_list" "$metadata_file"
        return 1
    fi

    rm -f "$concat_list" "$metadata_file"

    log_info "Created: $output_file"
    log_info "Chapters: $i"
}

# ------------------------------------------------------------------------------
# embed コマンド
# ------------------------------------------------------------------------------
cmd_embed() {
    local input_file=""
    local chapters_file=""
    local output_file=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help) show_embed_help; return 0 ;;
            -i|--input) input_file="$2"; shift 2 ;;
            -c|--chapters) chapters_file="$2"; shift 2 ;;
            -o|--output) output_file="$2"; shift 2 ;;
            -*) log_error "Unknown option: $1"; return 1 ;;
            *) shift ;;
        esac
    done

    if [[ -z "$input_file" ]]; then
        log_error "Input file (-i) is required"
        return 1
    fi

    if [[ -z "$chapters_file" ]]; then
        log_error "Chapters file (-c) is required"
        return 1
    fi

    if [[ ! -f "$input_file" ]]; then
        log_error "Input file not found: $input_file"
        return 1
    fi

    if [[ ! -f "$chapters_file" ]]; then
        log_error "Chapters file not found: $chapters_file"
        return 1
    fi

    if [[ -z "$output_file" ]]; then
        output_file="${input_file:r}_chapters.${input_file:e:-mp4}"
    fi

    log_step "Embedding chapters..."

    # チャプターファイルをffmpegメタデータ形式に変換
    local metadata_file=$(mktemp)
    local video_duration=$(get_duration "$input_file")

    echo ";FFMETADATA1" > "$metadata_file"

    local prev_time_ms=0
    local prev_title=""
    local count=0

    while IFS= read -r line; do
        # 空行やコメントをスキップ
        [[ -z "$line" || "$line" =~ ^# ]] && continue

        # タイムスタンプとタイトルを分離
        local timestamp="${line%% *}"
        local title="${line#* }"

        local time_sec=$(time_to_seconds "$timestamp")
        local time_ms=$(printf "%.0f" $(echo "$time_sec * 1000" | bc))

        # 前のチャプターを閉じる
        if [[ -n "$prev_title" ]]; then
            cat >> "$metadata_file" << EOF

[CHAPTER]
TIMEBASE=1/1000
START=${prev_time_ms}
END=${time_ms}
title=${prev_title}
EOF
            ((count++))
        fi

        prev_time_ms=$time_ms
        prev_title="$title"
    done < "$chapters_file"

    # 最後のチャプター
    if [[ -n "$prev_title" ]]; then
        local end_ms=$(printf "%.0f" $(echo "$video_duration * 1000" | bc))
        cat >> "$metadata_file" << EOF

[CHAPTER]
TIMEBASE=1/1000
START=${prev_time_ms}
END=${end_ms}
title=${prev_title}
EOF
        ((count++))
    fi

    # チャプター埋め込み
    if ! ffmpeg -hide_banner -loglevel warning -stats \
        -i "$input_file" -i "$metadata_file" \
        -map_metadata 1 -c copy -y "$output_file"; then
        log_error "Embedding failed"
        rm -f "$metadata_file"
        return 1
    fi

    rm -f "$metadata_file"

    log_info "Created: $output_file"
    log_info "Chapters: $count"
}

# ------------------------------------------------------------------------------
# extract コマンド
# ------------------------------------------------------------------------------
cmd_extract() {
    local input_file=""
    local output_file=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help) show_extract_help; return 0 ;;
            -i|--input) input_file="$2"; shift 2 ;;
            -o|--output) output_file="$2"; shift 2 ;;
            -*) log_error "Unknown option: $1"; return 1 ;;
            *) shift ;;
        esac
    done

    if [[ -z "$input_file" ]]; then
        log_error "Input file (-i) is required"
        return 1
    fi

    if [[ ! -f "$input_file" ]]; then
        log_error "Input file not found: $input_file"
        return 1
    fi

    # チャプター情報を抽出
    local chapters=$(ffprobe -v error -show_chapters \
        -print_format json "$input_file" 2>/dev/null)

    if [[ -z "$chapters" || "$chapters" == '{"chapters": []}' ]]; then
        log_warn "No chapters found in: $input_file"
        return 0
    fi

    # JSON形式から読みやすい形式に変換
    local formatted=$(echo "$chapters" | python3 -c '
import json, sys
data = json.load(sys.stdin)
for ch in data.get("chapters", []):
    start = float(ch.get("start_time", 0))
    title = ch.get("tags", {}).get("title", "Untitled")
    h = int(start // 3600)
    m = int((start % 3600) // 60)
    s = int(start % 60)
    print(f"{h:02d}:{m:02d}:{s:02d} {title}")
' 2>/dev/null)

    if [[ -n "$output_file" ]]; then
        echo "$formatted" > "$output_file"
        log_info "Chapters saved to: $output_file"
    else
        echo "$formatted"
    fi
}

# ------------------------------------------------------------------------------
# メイン
# ------------------------------------------------------------------------------
check_ffmpeg || return 1

local command="$1"
shift 2>/dev/null

case "$command" in
    concat)  cmd_concat "$@" ;;
    embed)   cmd_embed "$@" ;;
    extract) cmd_extract "$@" ;;
    -h|--help|"") show_help ;;
    *) log_error "Unknown command: $command"; show_help; return 1 ;;
esac

# ==============================================================================
# 使用例:
#   video-chapters concat -o combined.mp4 mov1.mp4 mov2.mp4
#   video-chapters embed -i video.mp4 -c chapters.txt -o output.mp4
#   video-chapters extract -i video.mp4
# ==============================================================================
